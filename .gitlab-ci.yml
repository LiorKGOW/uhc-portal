#
# Copyright (c) 2018 Red Hat, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# This pipeline builds, tests and deploys the OpenShift Unified Hybrid Cloud
# portal. In order to work it needs the following secret variables defined in
# the CI/CD configuration of the project:
#
# QUAY_USER - The name of the robot account used to push imagse to 'quay.io',
# for example 'openshift-unified-hybrid-cloud+gitlab'.
#
# QUAY_TOKEN - The token of the robot account.
#
# SANDBOX_URL, STAGING_URL and PRODUCTION_URL - The URL of the API server of the
# cluster where the application should be deployed, for example
# 'https://master.sandbox.private:8443'.
#
# SANDBOX_TOKEN, STAGING_TOKEN and PRODUCTION_TOKEN - The token of the service
# account that will be used to deploy the application. This service account
# should have the 'edit' role in the 'unified-hybrid-cloud' namespace.
#
# The runners that run this pipeline need to have access to internet and to the
# clusters where the application should be deployed.

stages:
- build
- push
- deploy

variables:
  DOCKER_CONFIG: .docker

build:
  stage: build
  script:
  - make version="${CI_COMMIT_TAG:-latest}" app image

push:
  stage: push
  only:
  - master@service/uhc-portal
  - tags@service/uhc-portal
  script:
  - mkdir -p "${DOCKER_CONFIG}"
  - docker login -u "${QUAY_USER}" -p "${QUAY_TOKEN}" quay.io
  - make version="${CI_COMMIT_TAG:-latest}" push
  - docker logout

deploy_sandbox:
  stage: deploy
  environment: sandbox
  only:
  - master@service/uhc-portal
  script:
  - oc login --token="${SANDBOX_TOKEN}" --insecure-skip-tls-verify "${SANDBOX_URL}"
  - make
      api_url="https://api.sandbox.private"
      domain="cloud.sandbox.private"
      image_pull_policy="Always"
      keycloak_realm="rhd"
      keycloak_resource="uhc"
      keycloak_url="https://developers.stage.redhat.com/auth"
      version="latest"
      deploy
  - oc logout

deploy_staging:
  stage: deploy
  environment: staging
  only:
  - tags@service/uhc-portal
  script:
  - oc login --token="${STAGING_TOKEN}" --insecure-skip-tls-verify "${STAGING_URL}"
  - make
      api_url="https://api.staging.private"
      domain="cloud.staging.private"
      keycloak_realm="rhd"
      keycloak_resource="uhc"
      keycloak_url="https://developers.stage.redhat.com/auth"
      version="${CI_COMMIT_TAG}"
      deploy
  - oc logout

deploy_production:
  stage: deploy
  environment: production
  only:
  - tags@service/uhc-portal
  when: manual
  script:
  - oc login --token="${PRODUCTION_TOKEN}" --insecure-skip-tls-verify "${PRODUCTION_URL}"
  - make
      api_url="https://api.production.private"
      domain="cloud.production.private"
      keycloak_realm="rhd"
      keycloak_resource="uhc"
      keycloak_url="https://developers.stage.redhat.com/auth"
      version="${CI_COMMIT_TAG}"
      deploy
  - oc logout
